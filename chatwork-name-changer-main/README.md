# Chatwork Name Changer v2

Chatworkの表示名を一時的に変更し、指定時間後に自動で元の名前に戻すためのGoogle Chrome拡張機能です。
このバージョンでは、Chatworkの内部API（gateway）を呼び出すことで、ページを閉じている間も変更を維持し、サーバー側で名前を更新します。

---

## 🚀 主要機能

- **名前変更の永続化**: 内部API呼び出しにより、ブラウザを閉じても名前を維持。
- **マルチモード対応**: 「ランチ中」と「休暇中」など、複数のステータスを同時に設定可能（全角スペースで連結されます）。
- **入力内容の自動保存**: 最後に使った文言や時間は自動保存され、次回起動時も引き継がれます。
- **URL事前認識**: 操作ミスを防ぐため、あらかじめ保存したChatworkのURL（マイチャット等）を開いている時のみ動作します。
- **自動復帰タイマー**: `chrome.alarms` を使用し、指定した時間（分単位）や日時（カレンダー指定）で高精度に復帰処理を行います。

## 🛠 メンテナンス・メンテナンス機能
「元の名前を間違えて保存してしまった」「タイマーが残ってしまった」場合のために、強力なメンテナンス機能を搭載しています。
- **現在名を取得**: 今のChatwork上の表示名をボタン一つで取得します。
- **名前を強制リセット**: 全てのタイマーを解除し、指定した名前にChatwork側も内部保存データも書き換えます。
- **名前の保存（記憶）だけ更新**: Chatwork側の名前は変えず、拡張機能が覚えている「元の名前」のデータだけを修正します。

---

## 📂 ファイル構成

- `manifest.json`: Manifest V3準拠の設定ファイル。
- `popup.html/css/js`: ユーザーインターフェース。設定の保存やタイマーの開始。
- `background.js`: Service Worker。ブラウザ終了後も動作するアラーム管理と同期ロジック。
- `content.js`: ページへのスクリプト注入とAPI実行の橋渡し。
- `page-script.js`: ChatworkのDOMから `ACCESS_TOKEN` や `MYID` を抽出。

---

## 🔧 インストール方法

1. Chromeブラウザで `chrome://extensions/` を開く。
2. 右上の「デベロッパーモード」をONにする。
3. 「パッケージ化されていない拡張機能を読み込む」ボタンをクリック。
4. このプロジェクトフォルダを選択して読み込む。

## 💡 使い方

1. **初期設定（URL登録）**: 
   - 拡張機能を起動し、自分のChatwork（マイチャット等）のURLを貼り付けて保存してください。
2. **モードの選択**:
   - **ランチモード**: 文言（例: 🍴ランチ中）と復帰までの時間（分）を指定して開始。
   - **有給/休暇モード**: 文言（例: 🌴有給）と復帰する日時を指定して開始。
   - ※ 両方有効にすると「名前　🌴有給　🍴ランチ中」のように連結されます。
3. **解除**:
   - 期限が来ると自動復帰しますが、「すべての設定を解除」ボタンからいつでも手動で戻せます。

---

## ⚠️ 注意事項

- **APIの実行条件**: APIの実行にはChatworkのタブが開いている必要があります。タブがない場合は、ポップアップ内の「Chatworkを開く」ボタンから保存したURLを開いてください。
- **アイコンについて**: 以下のファイルを別途用意して配置することを推奨します。
  - `icon16.png`, `icon48.png`, `icon128.png`
- **セキュリティ**: 本拡張機能は公式APIではなく内部ゲートウェイを使用しています。仕様変更により動作しなくなる可能性があります。

## 🔍 技術仕様

- **エンドポイント**: `https://www.chatwork.com/gateway/send_profile_setting.php`
- **メソッド**: `POST`
- **データ形式**: `application/x-www-form-urlencoded` (`pdata` パラメータにJSONを格納)
- **認証**: ログイン中のセッションCookieと、ページ内の `ACCESS_TOKEN` を使用。
